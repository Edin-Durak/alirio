---
import { Image } from "astro:assets";
import minusCircleIcon from "../assets/images/icons/minus-circle-icon.svg";
import plusCircleIcon from "../assets/images/icons/plus-circle-icon.svg";
import { getTranslations, getLangFromUrl } from '../i18n/ui';

const lang = getLangFromUrl(Astro.url);
const { content } = getTranslations(lang);

const faqData = [
  {
    id: 1,
    question: content.home.faq.question1.question,
    answer: content.home.faq.question1.answer
  },
  {
    id: 2,
    question: content.home.faq.question2.question,
    answer: content.home.faq.question2.answer
  },
  {
    id: 3,
    question: content.home.faq.question3.question,
    answer: content.home.faq.question3.answer
  },
  {
    id: 4,
    question: content.home.faq.question4.question,
    answer: content.home.faq.question4.answer
  },
  {
    id: 5,
    question: content.home.faq.question5.question,
    answer: content.home.faq.question5.answer
  },
  {
    id: 6,
    question: content.home.faq.question6.question,
    answer: content.home.faq.question6.answer
  }
];
---

<section class="faq-section" aria-labelledby="faq-title" data-minus-icon={minusCircleIcon.src} data-plus-icon={plusCircleIcon.src}>
  <div class="faq-section__inner container">
    <h2 class="faq-section__title" id="faq-title">
      {content.home.faq.title}
    </h2>
    <h3 class="faq-section__subtitle">
      {content.home.faq.subtitle}
    </h3>
    
    <div class="faq-section__content">
      {faqData.map((item, index) => (
                 <div class={`faq-item ${index === 0 ? 'faq-item--expanded' : ''}`} data-faq-id={item.id}>
           <button class="faq-item__trigger" aria-expanded={index === 0 ? "true" : "false"} aria-controls={`faq-answer-${item.id}`}>
             <span class="faq-item__question">{item.question}</span>
             <div class="faq-item__icon">
               {index === 0 ? (
                 <Image src={minusCircleIcon} alt="Collapse answer" width={24} height={24} class="faq-item__icon-minus" />
               ) : (
                 <Image src={plusCircleIcon} alt="Expand answer" width={24} height={24} class="faq-item__icon-plus" />
               )}
             </div>
           </button>
           <div class="faq-item__answer" id={`faq-answer-${item.id}`} aria-hidden={index === 0 ? "false" : "true"}>
             <p>{item.answer}</p>
           </div>
         </div>
      ))}
    </div>
  </div>
</section>

<script>
  class FAQAccordion {
    private faqItems: NodeListOf<Element>;
    private minusIconUrl: string;
    private plusIconUrl: string;

    constructor() {
      this.faqItems = document.querySelectorAll('.faq-item');
      const faqSection = document.querySelector('.faq-section');
      this.minusIconUrl = faqSection?.getAttribute('data-minus-icon') || '';
      this.plusIconUrl = faqSection?.getAttribute('data-plus-icon') || '';
      this.init();
    }

    init() {
      this.faqItems.forEach(item => {
        const trigger = item.querySelector('.faq-item__trigger') as HTMLButtonElement;
        const answer = item.querySelector('.faq-item__answer') as HTMLElement;
        const iconContainer = item.querySelector('.faq-item__icon') as HTMLElement;
        
        if (!trigger || !answer || !iconContainer) return;
        
        trigger.addEventListener('click', () => {
          const isExpanded = trigger.getAttribute('aria-expanded') === 'true';
          
          // Close all other items
          this.faqItems.forEach(otherItem => {
            if (otherItem !== item) {
              this.closeItem(otherItem);
            }
          });
          
          // Toggle current item
          if (isExpanded) {
            this.closeItem(item);
          } else {
            this.openItem(item);
          }
        });
      });
    }

         openItem(item) {
       const trigger = item.querySelector('.faq-item__trigger') as HTMLButtonElement;
       const answer = item.querySelector('.faq-item__answer') as HTMLElement;
       const iconContainer = item.querySelector('.faq-item__icon') as HTMLElement;
       
       if (!trigger || !answer || !iconContainer) return;
       
       // Set initial height to 0
       answer.style.height = '0px';
       
       // Force reflow
       answer.offsetHeight;
       
       // Add expanded class
       item.classList.add('faq-item--expanded');
       
       // Set final height
       const contentHeight = answer.scrollHeight;
       answer.style.height = contentHeight + 'px';
       
       // Update ARIA attributes
       trigger.setAttribute('aria-expanded', 'true');
       answer.setAttribute('aria-hidden', 'false');
       
               // Update icon
        iconContainer.innerHTML = `
          <img src="${this.minusIconUrl}" alt="Collapse answer" width="24" height="24" class="faq-item__icon-minus" />
        `;
       
       // Clean up after animation
       setTimeout(() => {
         answer.style.height = 'auto';
       }, 300);
     }

     closeItem(item) {
       const trigger = item.querySelector('.faq-item__trigger') as HTMLButtonElement;
       const answer = item.querySelector('.faq-item__answer') as HTMLElement;
       const iconContainer = item.querySelector('.faq-item__icon') as HTMLElement;
       
       if (!trigger || !answer || !iconContainer) return;
       
       // Set height to current height
       answer.style.height = answer.scrollHeight + 'px';
       
       // Force reflow
       answer.offsetHeight;
       
       // Animate to 0
       answer.style.height = '0px';
       
       // Remove expanded class
       item.classList.remove('faq-item--expanded');
       
       // Update ARIA attributes
       trigger.setAttribute('aria-expanded', 'false');
       answer.setAttribute('aria-hidden', 'true');
       
               // Update icon
        iconContainer.innerHTML = `
          <img src="${this.plusIconUrl}" alt="Expand answer" width="24" height="24" class="faq-item__icon-plus" />
        `;
     }
  }

  // Initialize FAQ accordion
  document.addEventListener('DOMContentLoaded', () => {
    new FAQAccordion();
  });
</script>

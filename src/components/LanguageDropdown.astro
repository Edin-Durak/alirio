---
import { Image } from "astro:assets";
import { getLangFromUrl, getTranslations as getTranslationsUI } from '../i18n/ui';
import ukFlag from "../assets/images/icons/Flag_of_the_United_Kingdom.svg";
import swedenFlag from "../assets/images/icons/Flag-Sweden.svg";
import bosniaFlag from "../assets/images/icons/Flag_of_Bosnia_and_Herzegovina.svg";
import saudiFlag from "../assets/images/icons/Flag_of_Saudi_Arabia.svg";

const lang = getLangFromUrl(Astro.url);
const { content } = getTranslationsUI(lang);

const languages = [
  { code: 'sv', name: 'Sweden', native: 'Sweden', flag: swedenFlag },
  { code: 'en', name: 'English', native: 'English', flag: ukFlag },
  { code: 'bs', name: 'Bosanski', native: 'Bosanski', flag: bosniaFlag },
  { code: 'ar', name: 'العربية', native: 'العربية', flag: saudiFlag }
];

// Get route mappings directly from translation files
const routeMappings = {
  en: getTranslationsUI('en').content.routes,
  bs: getTranslationsUI('bs').content.routes,
  sv: getTranslationsUI('sv').content.routes,
  ar: getTranslationsUI('ar').content.routes,
};
---

<div class="language-dropdown">
  <button class="language-dropdown__trigger" aria-expanded="false" aria-haspopup="true">
    {(() => {
      const currentLanguage = languages.find(l => l.code === lang);
      return currentLanguage ? (
        <Image src={currentLanguage.flag} alt={`${currentLanguage.name} flag`} width={25} height={20} />
      ) : null;
    })()}
    <span class="language-dropdown__current">{lang.toUpperCase()}</span>
    <svg class="language-dropdown__arrow" width="12" height="8" viewBox="0 0 12 8" fill="none">
      <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>
  
  <ul class="language-dropdown__menu" role="menu">
    {languages.map((language) => (
      <li class="language-dropdown__item" role="none">
        <button 
          class={`language-dropdown__option ${language.code === lang ? 'language-dropdown__option--active' : ''}`}
          data-lang={language.code}
          role="menuitem"
        >
          <Image src={language.flag} alt={`${language.name} flag`} width={25} height={20} />
          <span class="language-dropdown__name">{language.native}</span>
        </button>
      </li>
    ))}
  </ul>
</div>

<script define:vars={{ routeMappings }}>
  /**
   * @typedef {Object} LanguageDropdown
   * @property {HTMLElement} dropdown
   * @property {HTMLButtonElement} trigger
   * @property {HTMLElement} menu
   * @property {NodeList} options
   */
  
  class LanguageDropdown {
    /**
     * @type {HTMLElement}
     */
    dropdown;
    
    /**
     * @type {HTMLButtonElement}
     */
    trigger;
    
    /**
     * @type {HTMLElement}
     */
    menu;
    
    /**
     * @type {NodeList}
     */
    options;
    
    constructor(element) {
      this.dropdown = element;
      this.trigger = element.querySelector('.language-dropdown__trigger');
      this.menu = element.querySelector('.language-dropdown__menu');
      this.options = element.querySelectorAll('.language-dropdown__option');
      
      this.init();
    }
    
    init() {
      if (!this.trigger) {
        return;
      }
      
      this.trigger.addEventListener('click', () => this.toggle());
      
      this.options.forEach(option => {
        option.addEventListener('click', (e) => this.selectLanguage(e));
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!this.dropdown.contains(e.target)) {
          this.close();
        }
      });
      
      // Close on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          this.close();
        }
      });
      
      // Check for stored language preference on page load
      this.checkStoredLanguagePreference();
    }
    
    checkStoredLanguagePreference() {
      const storedLang = localStorage.getItem('preferredLanguage');
      if (storedLang && storedLang !== 'sv') {
        // Check if we're not already on the stored language
        const currentPath = window.location.pathname;
        const pathSegments = currentPath.split('/').filter(segment => segment);
        
        // If we're on Swedish (default) and have a stored preference, redirect
        if (pathSegments.length === 0 || !['en', 'bs', 'ar'].includes(pathSegments[0])) {
          // We're on Swedish page, redirect to stored language
          window.location.href = `/${storedLang}/`;
        }
      }
    }
    
    toggle() {
      const isExpanded = this.trigger.getAttribute('aria-expanded') === 'true';
      if (isExpanded) {
        this.close();
      } else {
        this.open();
      }
    }
    
    open() {
      this.trigger.setAttribute('aria-expanded', 'true');
      this.menu.classList.add('language-dropdown__menu--open');
      this.trigger.classList.add('language-dropdown__trigger--open');
    }
    
    close() {
      this.trigger.setAttribute('aria-expanded', 'false');
      this.menu.classList.remove('language-dropdown__menu--open');
      this.trigger.classList.remove('language-dropdown__trigger--open');
    }
    
    selectLanguage(event) {
      const option = event.currentTarget;
      const targetLang = option.dataset.lang;
      
      // Close dropdown
      this.close();
      
      // Save language preference to localStorage
      localStorage.setItem('preferredLanguage', targetLang);
      
      // Get current path
      const currentPath = window.location.pathname;
      const pathSegments = currentPath.split('/').filter(segment => segment);
      
      // Determine current page type and language
      let currentLang = 'sv'; // Default language
      let currentRoute = '';
      let pageType = 'home';
      
      // Check if current path has a language prefix
      const supportedLanguages = ['en', 'bs', 'ar'];
      if (pathSegments.length > 0 && supportedLanguages.includes(pathSegments[0])) {
        currentLang = pathSegments[0];
        // Decode the route segments to handle Arabic/Unicode characters
        currentRoute = pathSegments.slice(1).map(segment => decodeURIComponent(segment)).join('/');
      } else {
        // Swedish (default) - no language prefix
        currentRoute = pathSegments.map(segment => decodeURIComponent(segment)).join('/');
      }
      
      // Find the current page type by matching the route
      const currentLangRoutes = routeMappings[currentLang];
      
      if (currentLangRoutes) {
        // First try exact match
        for (const [type, route] of Object.entries(currentLangRoutes)) {
          if (currentRoute === route) {
            pageType = type;
            break;
          }
        }
        
        // If no exact match found, try to determine page type by position/index
        if (pageType === 'home') {
          // Check if we're on a non-home page by looking at the route structure
          if (currentRoute !== '') {
            // We're on a non-home page, try to determine which one
            // Check if it's services, about, or pricing based on the current language routes
            const routeEntries = Object.entries(currentLangRoutes);
            for (let i = 0; i < routeEntries.length; i++) {
              const [type, route] = routeEntries[i];
              if (route === currentRoute) {
                pageType = type;
                break;
              }
            }
          }
        }
      }
      
      // Get the target route for the new language
      const targetLangRoutes = routeMappings[targetLang];
      if (!targetLangRoutes) return;
      
      const targetRoute = targetLangRoutes[pageType];
      if (targetRoute === undefined) return;
      
      // Build the target URL
      let targetPath;
      if (targetLang === 'sv') {
        // Swedish is default - no language prefix
        targetPath = targetRoute === '' ? '/' : `/${targetRoute}/`;
      } else {
        // Other languages need language prefix
        targetPath = targetRoute === '' ? `/${targetLang}/` : `/${targetLang}/${targetRoute}/`;
      }
      
      // Navigate to the target page
      window.location.href = targetPath;
    }
  }
  
  // Initialize all language dropdowns
  document.addEventListener('DOMContentLoaded', () => {
    const dropdowns = document.querySelectorAll('.language-dropdown');
    dropdowns.forEach(dropdown => new LanguageDropdown(dropdown));
  });
  
  // Also try to initialize immediately if DOM is already loaded
  if (document.readyState !== 'loading') {
    const dropdowns = document.querySelectorAll('.language-dropdown');
    dropdowns.forEach(dropdown => new LanguageDropdown(dropdown));
  }
</script> 
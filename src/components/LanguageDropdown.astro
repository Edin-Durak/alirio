---
import { Image } from "astro:assets";
import languagesIcon from "../assets/images/icons/languages-icon.svg";
import { getLangFromUrl, getTranslations } from '../i18n/ui';

const lang = getLangFromUrl(Astro.url);
const { content } = getTranslations(lang);

const languages = [
  { code: 'en', name: 'English', native: 'English' },
  { code: 'sv', name: 'Sweden', native: 'Sweden' },
  { code: 'bs', name: 'Bosanski', native: 'Bosanski' },
  { code: 'ar', name: 'العربية', native: 'العربية' },
  { code: 'ku', name: 'کوردی', native: 'کوردی' },
  { code: 'sy', name: 'ܣܘܪܝܝܐ', native: 'ܣܘܪܝܝܐ' }
];

// Route mapping for all languages
const routeMappings = {
  en: { home: '', services: 'services', pricing: 'pricing', about: 'about' },
  bs: { home: '', services: 'usluge', pricing: 'cijene', about: 'o-nama' },
  sv: { home: '', services: 'tjanster', pricing: 'priser', about: 'om-oss' },
  ar: { home: '', services: 'خدمات', pricing: 'الأسعار', about: 'حول' },
  ku: { home: '', services: 'خزمەتگوزارییەکان', pricing: 'نرخەکان', about: 'دەربارە' },
  sy: { home: '', services: 'ܬܫܡܫܬܐ', pricing: 'ܐܣܟܡܐ', about: 'ܥܠ' }
};
---

<div class="language-dropdown">
  <button class="language-dropdown__trigger" aria-expanded="false" aria-haspopup="true">
    <Image src={languagesIcon} alt="Languages icon" width={20} height={20} />
    <span class="language-dropdown__current">{lang.toUpperCase()}</span>
    <svg class="language-dropdown__arrow" width="12" height="8" viewBox="0 0 12 8" fill="none">
      <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>
  
  <ul class="language-dropdown__menu" role="menu">
    {languages.map((language) => (
      <li class="language-dropdown__item" role="none">
        <button 
          class={`language-dropdown__option ${language.code === lang ? 'language-dropdown__option--active' : ''}`}
          data-lang={language.code}
          role="menuitem"
        >
          <span class="language-dropdown__code">{language.code.toUpperCase()}</span>
          <span class="language-dropdown__name">{language.native}</span>
        </button>
      </li>
    ))}
  </ul>
</div>

<script define:vars={{ routeMappings }}>
  /**
   * @typedef {Object} LanguageDropdown
   * @property {HTMLElement} dropdown
   * @property {HTMLButtonElement} trigger
   * @property {HTMLElement} menu
   * @property {NodeList} options
   */
  
  class LanguageDropdown {
    /**
     * @type {HTMLElement}
     */
    dropdown;
    
    /**
     * @type {HTMLButtonElement}
     */
    trigger;
    
    /**
     * @type {HTMLElement}
     */
    menu;
    
    /**
     * @type {NodeList}
     */
    options;
    
    constructor(element) {
      this.dropdown = element;
      this.trigger = element.querySelector('.language-dropdown__trigger');
      this.menu = element.querySelector('.language-dropdown__menu');
      this.options = element.querySelectorAll('.language-dropdown__option');
      
      this.init();
    }
    
    init() {
      this.trigger.addEventListener('click', () => this.toggle());
      this.options.forEach(option => {
        option.addEventListener('click', (e) => this.selectLanguage(e));
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!this.dropdown.contains(e.target)) {
          this.close();
        }
      });
      
      // Close on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          this.close();
        }
      });
    }
    
    toggle() {
      const isExpanded = this.trigger.getAttribute('aria-expanded') === 'true';
      if (isExpanded) {
        this.close();
      } else {
        this.open();
      }
    }
    
    open() {
      this.trigger.setAttribute('aria-expanded', 'true');
      this.menu.classList.add('language-dropdown__menu--open');
      this.trigger.classList.add('language-dropdown__trigger--open');
    }
    
    close() {
      this.trigger.setAttribute('aria-expanded', 'false');
      this.menu.classList.remove('language-dropdown__menu--open');
      this.trigger.classList.remove('language-dropdown__trigger--open');
    }
    
    selectLanguage(event) {
      const option = event.currentTarget;
      const langCode = option.dataset.lang;
      
      // Close dropdown
      this.close();
      
      // Get current path
      const currentPath = window.location.pathname;
      const pathSegments = currentPath.split('/').filter(segment => segment);
      
      let targetPath = '';
      
      // Check if current path has a language prefix
      const supportedLanguages = ['en', 'sv', 'bs', 'ar', 'ku', 'sy'];
      const hasLanguagePrefix = pathSegments.length > 0 && supportedLanguages.includes(pathSegments[0]);
      
      if (hasLanguagePrefix) {
        // Current path has language prefix (e.g., /bs/usluge)
        const currentLang = pathSegments[0];
        const currentRoute = pathSegments.slice(1).join('/');
        
        // Find the page type by matching current route
        const currentLangRoutes = routeMappings[currentLang];
        let pageType = 'home';
        
        for (const [type, route] of Object.entries(currentLangRoutes)) {
          if (currentRoute === route || (route === '' && currentRoute === '')) {
            pageType = type;
            break;
          }
        }
        
        // Get translated route for target language
        const targetLangRoutes = routeMappings[langCode];
        const targetRoute = targetLangRoutes[pageType];
        
        // Build target URL
        if (langCode === 'en') {
          targetPath = '/' + targetRoute;
        } else {
          targetPath = `/${langCode}/${targetRoute}`;
        }
        
        // Handle root path for English
        if (langCode === 'en' && targetRoute === '') {
          targetPath = '/';
        }
      } else {
        // Current path has no language prefix (e.g., /services)
        const currentRoute = pathSegments.join('/');
        
        // Find the page type by matching current route
        const currentLangRoutes = routeMappings['en'];
        let pageType = 'home';
        
        for (const [type, route] of Object.entries(currentLangRoutes)) {
          if (currentRoute === route || (route === '' && currentRoute === '')) {
            pageType = type;
            break;
          }
        }
        
        // Get translated route for target language
        const targetLangRoutes = routeMappings[langCode];
        const targetRoute = targetLangRoutes[pageType];
        
        // Build target URL
        if (langCode === 'en') {
          targetPath = '/' + targetRoute + "/";
        } else {
          targetPath = `/${langCode}/${targetRoute}/`;
        }
        
        // Handle root path for English
        if (langCode === 'en' && targetRoute === '') {
          targetPath = '/';
        }
      }
      
      // Navigate to the target page
      window.location.href = targetPath;
    }
  }
  
  // Initialize all language dropdowns
  document.addEventListener('DOMContentLoaded', () => {
    const dropdowns = document.querySelectorAll('.language-dropdown');
    dropdowns.forEach(dropdown => new LanguageDropdown(dropdown));
  });
</script> 